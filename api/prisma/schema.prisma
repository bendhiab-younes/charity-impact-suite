generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// =============================================================================
// SIMPLIFIED CHARITY MANAGEMENT SYSTEM
// =============================================================================
// 
// FLOW:
// 1. CONTRIBUTIONS (Money IN): Donor (anonymous/authenticated) → Association
//    - Donor makes contribution → Admin/Member approves → Budget increases
// 
// 2. DONATIONS (Aid OUT): Association → Beneficiary
//    - Staff creates donation using budget → Rules checked → Aid given
//    - Rules: frequency cooldown, amount limits based on family members
//
// 3. PUBLIC TRANSPARENCY: Anyone can view ins/outs without authentication
//
// =============================================================================

// UserRole: SUPER_ADMIN, ASSOCIATION_ADMIN, ASSOCIATION_MEMBER, DONOR
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String
  role          String   @default("DONOR")
  avatar        String?
  
  association   Association? @relation(fields: [associationId], references: [id])
  associationId String?
  
  // Relations
  contributions   Contribution[] @relation("DonorContributions")
  processedDonations Donation[]  @relation("ProcessedDonations")
  activityLogs    ActivityLog[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// AssociationStatus: ACTIVE, PENDING, SUSPENDED
model Association {
  id          String   @id @default(cuid())
  name        String
  description String
  logo        String?
  website     String?
  email       String
  phone       String?
  address     String?
  status      String   @default("PENDING")
  budget      Float    @default(0)  // Available budget from approved contributions
  category    String?
  
  // Relations
  users         User[]
  beneficiaries Beneficiary[]
  families      Family[]
  contributions Contribution[]  // Money IN from donors
  donations     Donation[]      // Aid OUT to beneficiaries
  rules         DonationRule[]
  activityLogs  ActivityLog[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// FamilyStatus: ELIGIBLE, INELIGIBLE, COOLDOWN
model Family {
  id              String    @id @default(cuid())
  name            String
  memberCount     Int       @default(1)
  address         String?
  status          String    @default("ELIGIBLE")
  totalReceived   Float     @default(0)
  lastDonationDate DateTime?
  
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  associationId String
  
  beneficiaries Beneficiary[]
  donations     Donation[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// BeneficiaryStatus: ELIGIBLE, INELIGIBLE, PENDING_REVIEW
model Beneficiary {
  id               String    @id @default(cuid())
  nationalId       String?   @unique  // National ID for lookup (no account needed)
  firstName        String
  lastName         String
  email            String?
  phone            String?
  address          String?
  status           String    @default("PENDING_REVIEW")
  totalReceived    Float     @default(0)
  lastDonationDate DateTime?
  eligibilityNotes String?
  
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  associationId String
  
  family        Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  familyId      String
  
  donations     Donation[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// =============================================================================
// CONTRIBUTION: Money coming IN from donors
// =============================================================================
// ContributionStatus: PENDING, APPROVED, REJECTED
model Contribution {
  id          String    @id @default(cuid())
  amount      Float
  currency    String    @default("TND")
  status      String    @default("PENDING")
  type        String    @default("ONE_TIME")  // ONE_TIME, RECURRING
  method      String    @default("CARD")      // CARD, BANK_TRANSFER, CASH, CHECK
  notes       String?
  approvedAt  DateTime?
  approvedBy  String?   // User ID who approved
  
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  associationId String
  
  // Authenticated donor (optional)
  donor       User?     @relation("DonorContributions", fields: [donorId], references: [id])
  donorId     String?
  
  // Anonymous donor info
  donorName   String?
  donorEmail  String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// =============================================================================
// DONATION: Aid going OUT to beneficiaries (from budget)
// =============================================================================
// DonationStatus: COMPLETED, CANCELLED
model Donation {
  id          String    @id @default(cuid())
  amount      Float
  currency    String    @default("TND")
  status      String    @default("COMPLETED")
  aidType     String    @default("CASH")  // CASH, FOOD, CLOTHING, MEDICAL, EDUCATION, OTHER
  notes       String?
  
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  associationId String
  
  beneficiary   Beneficiary @relation(fields: [beneficiaryId], references: [id])
  beneficiaryId String
  
  family        Family? @relation(fields: [familyId], references: [id])
  familyId      String?
  
  // Staff member who created this donation
  processedBy   User?   @relation("ProcessedDonations", fields: [processedById], references: [id])
  processedById String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// =============================================================================
// RULES: Association rules for donations
// =============================================================================
// RuleType: FREQUENCY (cooldown days), AMOUNT (max per family member), ELIGIBILITY (min members)
model DonationRule {
  id          String   @id @default(cuid())
  name        String
  description String
  type        String   // FREQUENCY, AMOUNT, ELIGIBILITY
  value       Float
  unit        String?  // days, TND, members
  isActive    Boolean  @default(true)
  
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  associationId String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// =============================================================================
// ACTIVITY LOG: Full audit trail
// =============================================================================
model ActivityLog {
  id         String   @id @default(cuid())
  action     String
  details    String
  entityType String   // CONTRIBUTION, DONATION, BENEFICIARY, etc.
  entityId   String
  
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  associationId String
  
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  
  createdAt  DateTime @default(now())
}
